import React, { Component } from "react";
import AMapLoader from "@amap/amap-jsapi-loader";
import mapConfig from "../../config/map";
import styles from "./index.css";
import { Checkbox, message, Modal, Descriptions, Tabs, Table } from "antd";
import pointData from "../../config/basicInfo";

const { TabPane } = Tabs;

class MapContainer extends Component {
  constructor() {
    super();
    this.map = null;
    this.AMap = null;
    this.markers = [];
    this.state = {
      loading: true,
      layers: {
        satellite: false,
        roadNet: false,
        traffic: false,
        terrain: false
      },
      pointTypes: {
        enterprise: false,
        antimonyMine: false,
        mineTunnel: false,
        wasteResidue: false
      },
      modalVisible: false,
      currentStation: null,
      realTimeData: [],
      weeklyData: []
    };
  }

  componentDidMount() {
    this.initMap();
  }

  componentWillUnmount() {
    if (this.map) {
      this.map.destroy();
    }
  }

  // 初始化地图
  initMap = async () => {
    try {
      // 配置安全密钥
      window._AMapSecurityConfig = {
        securityJsCode: mapConfig.SECURITY_CODE,
      };

      // 加载高德地图
      this.AMap = await AMapLoader.load({
        key: mapConfig.KEY,
        version: mapConfig.VERSION,
        plugins: mapConfig.PLUGINS,
      });

      // 创建地图实例
      this.map = new this.AMap.Map("container", {
        mapStyle: "amap://styles/fresh",
        // rotateEnable: false,
        // pitchEnable: true,
        zoom: 7,
        // pitch: 80,
        // rotation: 80,
        viewMode: "3D",
        zooms: [2, 20],
        center: [115.121282, 37.222719],
        terrain: this.state.layers.terrain
      });

      // 添加控件
      this.map.addControl(new this.AMap.ToolBar());
      this.map.addControl(new this.AMap.MapType());

      // 创建图层
      this.satelliteLayer = new this.AMap.TileLayer.Satellite();
      this.roadNetLayer = new this.AMap.TileLayer.RoadNet();
      this.trafficLayer = new this.AMap.TileLayer.Traffic();

      // 加载站点数据
      this.loadStationMarkers();

      this.setState({ loading: false });
    } catch (error) {
      console.error("地图初始化失败:", error);
      message.error("地图初始化失败");
    }
  };

  // 加载实时监测数据
  loadRealTimeData = async (stationId) => {
    try {
      // TODO: 替换为实际的API调用
      const mockData = [
        { factor: 'COD', value: '45.2', limit: '50' },
        { factor: '氨氮', value: '2.1', limit: '5' },
        { factor: '总磷', value: '0.3', limit: '0.5' }
      ];
      this.setState({ realTimeData: mockData });
    } catch (error) {
      console.error("加载实时数据失败:", error);
      message.error("加载实时数据失败");
    }
  };

  // 加载近一周数据
  loadWeeklyData = async (stationId) => {
    try {
      // TODO: 替换为实际的API调用
      const mockData = [
        { factor: 'COD', value: '42.5', limit: '50' },
        { factor: '氨氮', value: '1.8', limit: '5' },
        { factor: '总磷', value: '0.25', limit: '0.5' }
      ];
      this.setState({ weeklyData: mockData });
    } catch (error) {
      console.error("加载周数据失败:", error);
      message.error("加载周数据失败");
    }
  };

  // 处理标签页切换
  handleTabChange = (key) => {
    if (this.state.currentStation) {
      if (key === 'realtime') {
        this.loadRealTimeData(this.state.currentStation.id);
      } else if (key === 'weekly') {
        this.loadWeeklyData(this.state.currentStation.id);
      }
    }
  };

  // 加载站点标记
  loadStationMarkers = async () => {
    try {
      const response = await fetch("http://127.0.0.1:8080/api/list_station_message");
      const stations = await response.json();

      // 清除现有标记
      this.clearMarkers();

      // 创建新标记
      stations.forEach(station => {
        const markerContent = `
          <div class="${styles.customContentMarker}">
            <img src="/mark.png" style="width: 28px;height: 40px">
          </div>
        `;

        const position = new this.AMap.LngLat(station.longitude, station.latitude);
        const marker = new this.AMap.Marker({
          position: position,
          content: markerContent,
          offset: new this.AMap.Pixel(-13, -30),
          title: station.stationName
        });

        // 添加点击事件
        marker.on('click', () => {
          this.setState({
            modalVisible: true,
            currentStation: station
          }, () => {
            // 加载实时数据
            this.loadRealTimeData(station.id);
          });
        });

        this.map.add(marker);
        this.markers.push(marker);
      });
    } catch (error) {
      console.error("加载站点数据失败:", error);
      message.error("加载站点数据失败");
    }
  };

  // 清除所有标记
  clearMarkers = () => {
    this.markers.forEach(marker => {
      this.map.remove(marker);
    });
    this.markers = [];
  };

  // 切换图层
  toggleLayer = (layerName) => {
    const { layers } = this.state;
    const newLayers = { ...layers, [layerName]: !layers[layerName] };
    this.setState({ layers: newLayers });

    switch (layerName) {
      case "satellite":
        newLayers[layerName]
          ? this.map.add(this.satelliteLayer)
          : this.map.remove(this.satelliteLayer);
        break;
      case "roadNet":
        newLayers[layerName]
          ? this.map.add(this.roadNetLayer)
          : this.map.remove(this.roadNetLayer);
        break;
      case "traffic":
        newLayers[layerName]
          ? this.map.add(this.trafficLayer)
          : this.map.remove(this.trafficLayer);
        break;
      case "terrain":
        this.map.setTerrain(newLayers[layerName]);
        break;
      default:
        break;
    }
  };

  // 定位到当前位置
  locateCurrentPosition = () => {
    const geolocation = new this.AMap.Geolocation({
      enableHighAccuracy: true,
      timeout: 10000,
      buttonPosition: "RB",
      buttonOffset: new this.AMap.Pixel(10, 20),
      zoomToAccuracy: true,
    });

    this.map.addControl(geolocation);
    geolocation.getCurrentPosition();
  };

  // 重置地图视图
  resetMapView = () => {
    this.map.setZoomAndCenter(mapConfig.DEFAULT_ZOOM, mapConfig.DEFAULT_CENTER);
  };

  // 处理模态框关闭
  handleModalClose = () => {
    this.setState({
      modalVisible: false,
      currentStation: null,
      realTimeData: [],
      weeklyData: []
    });
  };

  // 加载标记点
  loadMarkers = () => {
    // 清除现有标记
    this.clearMarkers();

    const { pointTypes } = this.state;

    // 加载企业标记
    if (pointTypes.enterprise) {
      pointData.qiye.forEach(enterprise => {
        this.addMarker(enterprise, 'enterprise');
      });
    }

    // 加载锑矿标记
    if (pointTypes.antimonyMine) {
      pointData.kuangqu.forEach(mine => {
        this.addMarker(mine, 'antimonyMine');
      });
    }

    // 加载矿硐标记
    if (pointTypes.mineTunnel) {
      pointData.kuangdong[0].forEach(tunnel => {
        this.addMarker(tunnel, 'mineTunnel');
      });
    }

    // 加载废渣标记
    if (pointTypes.wasteResidue) {
      pointData.feizhe.forEach(residue => {
        this.addMarker(residue, 'wasteResidue');
      });
    }
  };

  // 添加单个标记
  addMarker = (point, type) => {
    const markerContent = this.getMarkerContent(type);
    const position = new this.AMap.LngLat(point.longitude, point.latitude);
    
    const marker = new this.AMap.Marker({
      position: position,
      content: markerContent,
      offset: new this.AMap.Pixel(-13, -30),
      title: point.name
    });

    // 添加点击事件
    marker.on('click', () => {
      this.setState({
        modalVisible: true,
        currentStation: {
          stationName: point.name,
          longitude: point.longitude,
          latitude: point.latitude,
          type: type
        }
      });
    });

    this.map.add(marker);
    this.markers.push(marker);
  };

  // 获取标记点样式
  getMarkerContent = (type) => {
    const colors = {
      enterprise: '#1890ff',
      antimonyMine: '#52c41a',
      mineTunnel: '#faad14',
      wasteResidue: '#f5222d'
    };

    return `
      <div style="
        width: 24px;
        height: 24px;
        background: ${colors[type]};
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      "></div>
    `;
  };

  // 切换标记点显示
  togglePointType = (type) => {
    const { pointTypes } = this.state;
    const newPointTypes = { ...pointTypes, [type]: !pointTypes[type] };
    this.setState({ pointTypes: newPointTypes }, () => {
      this.loadMarkers();
    });
  };

  render() {
    const { layers, pointTypes, modalVisible, currentStation, realTimeData, weeklyData } = this.state;

    // 表格列定义
    const columns = [
      {
        title: '监测因子',
        dataIndex: 'factor',
        key: 'factor',
      },
      {
        title: '监测值',
        dataIndex: 'value',
        key: 'value',
      },
      {
        title: '标准限值',
        dataIndex: 'limit',
        key: 'limit',
      }
    ];

    return (
      <div className={styles.container}>
        {/* 标记点控制面板 */}
        <div style={{
          position: 'fixed',
          right: 30,
          bottom: 200,
          width: 120,
          background: 'rgba(60, 100, 150, 0.85)',
          borderRadius: 16,
          padding: '12px 16px',
          color: '#fff',
          fontSize: 12,
          zIndex: 1000,
          boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
        }}>
          <div style={{fontWeight: 'bold', fontSize: 14, marginBottom: 8, textAlign: 'center'}}>标记点控制</div>
          <div style={{display: 'flex', alignItems: 'center', marginBottom: 4}}>
            <Checkbox
              checked={pointTypes.enterprise}
              onChange={() => this.togglePointType("enterprise")}
              style={{color: '#fff'}}
            >
              企业
            </Checkbox>
          </div>
          <div style={{display: 'flex', alignItems: 'center', marginBottom: 4}}>
            <Checkbox
              checked={pointTypes.antimonyMine}
              onChange={() => this.togglePointType("antimonyMine")}
              style={{color: '#fff'}}
            >
              锑矿
            </Checkbox>
          </div>
          <div style={{display: 'flex', alignItems: 'center', marginBottom: 4}}>
            <Checkbox
              checked={pointTypes.mineTunnel}
              onChange={() => this.togglePointType("mineTunnel")}
              style={{color: '#fff'}}
            >
              矿硐
            </Checkbox>
          </div>
          <div style={{display: 'flex', alignItems: 'center'}}>
            <Checkbox
              checked={pointTypes.wasteResidue}
              onChange={() => this.togglePointType("wasteResidue")}
              style={{color: '#fff'}}
            >
              废渣
            </Checkbox>
          </div>
        </div>

        <div id="container" style={{ height: "90vh" }}></div>

        {/* 图例说明 */}
        <div style={{
          position: 'fixed',
          right: 30,
          bottom: 30,
          width: 120,
          background: 'rgba(60, 100, 150, 0.85)',
          borderRadius: 16,
          padding: '12px 16px',
          color: '#fff',
          fontSize: 12,
          zIndex: 1000,
          boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
        }}>
          <div style={{fontWeight: 'bold', fontSize: 14, marginBottom: 8, textAlign: 'center'}}>图例说明</div>
          <div style={{display: 'flex', alignItems: 'center', marginBottom: 4}}>
            <div style={{width: 24, height: 24, background: '#1890ff', marginRight: 8, borderRadius: '50%', border: '2px solid #fff'}}></div>
            企业
          </div>
          <div style={{display: 'flex', alignItems: 'center', marginBottom: 4}}>
            <div style={{width: 24, height: 24, background: '#52c41a', marginRight: 8, borderRadius: '50%', border: '2px solid #fff'}}></div>
            锑矿
          </div>
          <div style={{display: 'flex', alignItems: 'center', marginBottom: 4}}>
            <div style={{width: 24, height: 24, background: '#faad14', marginRight: 8, borderRadius: '50%', border: '2px solid #fff'}}></div>
            矿硐
          </div>
          <div style={{display: 'flex', alignItems: 'center'}}>
            <div style={{width: 24, height: 24, background: '#f5222d', marginRight: 8, borderRadius: '50%', border: '2px solid #fff'}}></div>
            废渣
          </div>
        </div>

        <Modal
          title={currentStation?.stationName || "点位信息"}
          open={modalVisible}
          onCancel={this.handleModalClose}
          footer={null}
          width={600}
        >
          {currentStation && (
            <Descriptions bordered column={1}>
              <Descriptions.Item label="名称">
                {currentStation.stationName}
              </Descriptions.Item>
              <Descriptions.Item label="类型">
                {currentStation.type === 'enterprise' ? '企业' :
                 currentStation.type === 'antimonyMine' ? '锑矿' :
                 currentStation.type === 'mineTunnel' ? '矿硐' : '废渣'}
              </Descriptions.Item>
              <Descriptions.Item label="经度">
                {currentStation.longitude}
              </Descriptions.Item>
              <Descriptions.Item label="纬度">
                {currentStation.latitude}
              </Descriptions.Item>
            </Descriptions>
          )}
        </Modal>
      </div>
    );
  }
}

export default MapContainer;
